<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ù‚Ø±Ø¨Ù„ÙˆÙƒÙˆ ÙØ§Ø´ÙˆÙ† | Fashion Store</title>
    
    <meta name="theme-color" content="#bc13fe">
    <link rel="icon" href="images/logo.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neonBlue: '#00f3ff', neonPink: '#bc13fe', neonGreen: '#39ff14', darkBg: '#050505',
                    },
                    fontFamily: { cairo: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #050505; color: #fff; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .neon-box { border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5); transition: all 0.3s; }
        .neon-box:hover { border-color: #bc13fe; box-shadow: 0 0 15px rgba(188,19,254,0.3); transform: translateY(-2px); }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #bc13fe; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .option-input:checked + div { background: #bc13fe; color: white; border-color: #bc13fe; box-shadow: 0 0 10px rgba(188, 19, 254, 0.5); transform: scale(1.05); }
        .color-input:checked + div { border-color: #00f3ff; box-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="pb-32 relative">

    <nav class="fixed top-0 w-full z-50 bg-black/90 backdrop-blur-xl border-b border-white/10 shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="text-2xl font-black flex items-center gap-1">
                    <span class="text-white">Ø£Ù‚Ø±Ø¨</span><span class="text-neonPink">Ù„ÙˆÙƒÙˆ</span>
                    <i class="fas fa-tshirt text-neonBlue text-lg animate-pulse ml-1"></i>
                </div>
                <button onclick="openTrackModal()" class="mr-2 text-[10px] font-bold text-neonBlue border border-neonBlue/30 bg-neonBlue/10 px-3 py-1.5 rounded-full flex items-center gap-1 hover:bg-neonBlue/20 transition">
                    <i class="fas fa-motorcycle"></i> ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
                </button>
            </div>
        </div>
    </nav>

    <header class="mt-20 mb-6 px-4 text-center">
        <div class="bg-gradient-to-b from-gray-900 to-black rounded-3xl p-6 border border-gray-800 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-neonPink blur-[80px] opacity-10"></div>
            <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-neonBlue blur-[80px] opacity-10"></div>
            <h1 class="text-2xl md:text-3xl font-black mb-2 text-white">ÙØ§Ø´ÙˆÙ† Ø³ØªÙˆØ± <span class="text-neonBlue">Ø¹Ù„Ù‰ Ø°ÙˆÙ‚Ùƒ</span> ğŸ‘—</h1>
            <p class="text-gray-400 text-xs md:text-sm max-w-md mx-auto">Ø£Ø´ÙŠÙƒ Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯Ø§Øª.. Ù‚ÙŠØ³ ÙÙŠ Ø¨ÙŠØªÙƒ ÙˆØ§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù….</p>
        </div>
    </header>

    <section class="container mx-auto px-3 md:px-4 mb-12">
        <div class="relative mb-6">
            <input type="text" id="searchInput" onkeyup="searchProducts()" placeholder="Ø¨ØªØ¯ÙˆØ± Ø¹Ù„Ù‰ ØªÙŠØ´Ø±ØªØŒ Ø¨Ù†Ø·Ù„ÙˆÙ†ØŒ ÙØ³ØªØ§Ù†ØŸ" 
                class="w-full bg-gray-900/80 border border-gray-700 text-white rounded-2xl py-3.5 px-11 focus:border-neonBlue focus:ring-1 focus:ring-neonBlue outline-none transition duration-300">
            <i class="fas fa-search absolute right-4 top-4 text-gray-500"></i>
        </div>

        <div class="sticky top-[60px] z-40 bg-[#050505]/95 backdrop-blur-sm py-2 mb-2 border-b border-white/5 -mx-4 px-4">
            <div id="categories-container" class="flex overflow-x-auto gap-2 no-scrollbar pb-1"></div>
        </div>

        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4 mb-8">
            <div class="col-span-full text-center py-10 text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆÙ„ÙŠÙƒØ´Ù†...</div>
        </div>
    </section>

    <div id="variant-modal" class="fixed inset-0 z-[70] hidden flex items-end md:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeVariantModal()"></div>
        <div class="bg-[#111] w-full max-w-md rounded-t-3xl md:rounded-3xl border border-white/10 relative animate-slide overflow-hidden flex flex-col max-h-[90vh]">
            <div class="overflow-y-auto custom-scrollbar p-5 pb-24">
                
                <div id="modal-images" class="flex overflow-x-auto gap-2 snap-x snap-mandatory mb-4 no-scrollbar">
                    </div>
                
                <h2 id="modal-title" class="text-2xl font-black text-white mb-1"></h2>
                <p id="modal-price" class="text-neonBlue font-bold text-xl mb-3"></p>
                <p id="modal-desc" class="text-gray-300 text-sm leading-relaxed mb-6 border-b border-gray-800 pb-4"></p>
                <div class="mb-4">
                    <p class="text-xs text-gray-400 mb-2 font-bold flex justify-between"><span>Ø§Ù„Ù…Ù‚Ø§Ø³:</span> <span id="size-label" class="text-neonPink"></span></p>
                    <div id="modal-sizes" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="mb-2">
                    <p class="text-xs text-gray-400 mb-2 font-bold flex justify-between"><span>Ø§Ù„Ù„ÙˆÙ†:</span> <span id="color-label" class="text-neonBlue"></span></p>
                    <div id="modal-colors" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="absolute bottom-0 w-full p-4 bg-[#111] border-t border-gray-800 z-10">
                <button id="add-to-cart-btn" onclick="confirmAddToCart()" disabled class="w-full bg-gray-800 text-gray-500 font-bold py-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2">
                    <span>Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³ ÙˆØ§Ù„Ù„ÙˆÙ†</span> <i class="fas fa-hand-point-up"></i>
                </button>
            </div>
            <button onclick="closeVariantModal()" class="absolute top-4 left-4 bg-black/60 hover:bg-red-500/80 p-2 rounded-full text-white w-9 h-9 flex items-center justify-center transition z-50 border border-white/10 shadow-lg"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="cart-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="toggleCart()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-[#0a0a0a] rounded-t-3xl border-t border-white/10 shadow-2xl transform transition-transform duration-300 max-h-[90vh] flex flex-col">
            <div class="w-full flex justify-center pt-3 pb-1" onclick="toggleCart()"><div class="w-12 h-1.5 bg-gray-700/50 rounded-full"></div></div>
            <div class="px-6 py-4 flex justify-between items-center border-b border-white/10">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i class="fas fa-shopping-bag text-neonBlue"></i> Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ</h2>
                <button onclick="clearCart()" class="text-red-400 text-xs px-3 py-1.5 bg-red-500/10 rounded-full hover:bg-red-500/20"><i class="fas fa-trash-alt"></i> Ø¥ÙØ±Ø§Øº</button>
            </div>
            <div id="cart-items" class="p-4 overflow-y-auto flex-1 space-y-3 custom-scrollbar min-h-[200px]"></div>
            <div class="p-5 bg-black/40 border-t border-white/10 pb-8">
                <div class="flex justify-between items-center mb-4 text-lg font-bold"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <span class="text-neonBlue text-xl" id="modal-total-price">0 Ø¬.Ù…</span></div>
                <button onclick="openCheckoutModal()" class="w-full bg-neonPink hover:bg-purple-600 text-white font-bold py-3.5 rounded-xl flex justify-center items-center gap-2 shadow-lg transition transform active:scale-95">
                    <i class="fas fa-check-circle"></i> <span>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</span>
                </button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeCheckoutModal()"></div>
        <div class="bg-[#111] backdrop-blur-xl w-full max-w-md rounded-2xl border border-white/10 relative animate-slide overflow-hidden p-6">
            <h2 class="text-2xl font-black text-white mb-2 text-center">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ğŸ›µ</h2>
            <form id="checkout-form" onsubmit="event.preventDefault(); submitOrder();">
                <input type="text" id="customer-name" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 mb-3 text-white focus:border-neonBlue outline-none" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
                <input type="tel" id="customer-phone" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 mb-3 text-white focus:border-neonBlue outline-none" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" maxlength="11" required>
                <textarea id="customer-address" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 mb-4 text-white focus:border-neonBlue outline-none resize-none h-20" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„.." required></textarea>
                <button type="submit" class="w-full bg-gradient-to-r from-neonPink to-purple-800 text-white font-bold py-3 rounded-xl shadow-lg">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
            </form>
            <button onclick="closeCheckoutModal()" class="absolute top-4 left-4 text-gray-400 hover:text-white z-50"><i class="fas fa-times text-xl"></i></button>
        </div>
    </div>

    <div id="success-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
        <div class="bg-[#111] border border-neonGreen rounded-2xl p-6 text-center relative z-10 max-w-sm w-full shadow-[0_0_30px_rgba(57,255,20,0.3)] animate-slide">
            <div class="w-20 h-20 bg-neonGreen/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-neonGreen">
                <i class="fas fa-check text-4xl text-neonGreen"></i>
            </div>
            <h3 class="text-2xl font-black text-white mb-2">ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h3>
            <p class="text-gray-300 text-xs mb-4">Ø§Ø­ØªÙØ¸ Ø¨ÙƒÙˆØ¯ Ø§Ù„ØªØªØ¨Ø¹ Ø¯Ù‡ Ø¹Ø´Ø§Ù† ØªØ¹Ø±Ù Ø·Ù„Ø¨Ùƒ ÙˆØµÙ„ ÙÙŠÙ†:</p>
            <div class="bg-white/5 p-4 rounded-xl mb-6 border border-white/10 border-dashed">
                <span id="success-order-num" class="text-4xl font-mono font-black text-neonGreen tracking-widest select-all"></span>
            </div>
            <button onclick="closeSuccessModal()" class="w-full bg-neonGreen hover:bg-green-400 text-black font-bold py-3.5 rounded-xl transition shadow-[0_0_15px_rgba(57,255,20,0.4)]">Ø­Ø³Ù†Ø§Ù‹ ğŸ‘</button>
        </div>
    </div>

    <div id="track-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeTrackModal()"></div>
        <div class="bg-[#111] w-full max-w-md rounded-2xl border border-white/10 relative animate-slide p-6 text-center">
            <i class="fas fa-search-location text-4xl text-neonBlue mb-4"></i>
            <h2 class="text-xl font-black text-white mb-4">ØªØªØ¨Ø¹ Ø´Ø­Ù†ØªÙƒ</h2>
            <input type="number" id="track-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 mb-4 text-center text-white text-lg font-bold tracking-widest focus:border-neonBlue outline-none">
            <button onclick="trackOrder()" class="w-full bg-neonBlue text-black font-bold py-3 rounded-xl mb-4">Ø¨Ø­Ø«</button>
            <div id="track-result" class="hidden bg-white/5 p-4 rounded-xl border border-white/10"></div>
            <button onclick="closeTrackModal()" class="absolute top-4 left-4 text-gray-400 hover:text-white z-50"><i class="fas fa-times text-xl"></i></button>
        </div>
    </div>

    <div class="fixed bottom-5 left-4 right-4 z-40 max-w-lg mx-auto">
        <button onclick="toggleCart()" class="w-full bg-gray-900 border border-neonPink/50 text-white rounded-2xl shadow-[0_4px_20px_rgba(188,19,254,0.3)] overflow-hidden">
            <div class="bg-gradient-to-r from-neonPink/10 to-purple-900/20 backdrop-blur-md py-3 px-5 flex justify-between items-center h-full">
                <div class="flex items-center gap-3">
                    <div class="bg-neonPink text-white font-black w-8 h-8 rounded-lg flex items-center justify-center shadow-lg" id="cart-counter">0</div>
                    <span class="font-bold text-sm">Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ØªØ³ÙˆÙ‚</span>
                </div>
                <span class="font-black text-lg text-neonBlue" id="cart-total">0 Ø¬.Ù…</span>
            </div>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCUgMCQPD3LqQHhiJqGUykCvi4GkqIxBDg", authDomain: "akrabloko.firebaseapp.com", projectId: "akrabloko", storageBucket: "akrabloko.firebasestorage.app", messagingSenderId: "846428093028", appId: "1:846428093028:web:29f31599b90125c2673d71" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
        try { enableIndexedDbPersistence(db).catch(err => { if (err.code == 'failed-precondition') { console.log('Multiple tabs open'); } else if (err.code == 'unimplemented') { console.log('Browser no support'); } }); } catch(e){}

        // Variables
        let products = [], cart = JSON.parse(localStorage.getItem('akrabloko_cart')) || [];
        let selectedProduct = null, selectedSize = null, selectedColor = null;

        // Fetch Functions
        window.fetchCategories = async function() {
            const container = document.getElementById('categories-container');
            const defaultHtml = `<button onclick="filterProducts('all')" class="category-btn active px-4 py-2 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold transition-all whitespace-nowrap hover:bg-gray-700">Ø§Ù„ÙƒÙ„</button>`;
            const cachedCats = localStorage.getItem('akrabloko_cats');
            if (cachedCats && (Date.now() - localStorage.getItem('akrabloko_cats_time') < 3600000)) { renderCats(JSON.parse(cachedCats), defaultHtml); return; }
            try {
                const q = query(collection(db, "categories"), orderBy("name"));
                const snapshot = await getDocs(q);
                let cats = []; snapshot.forEach(doc => cats.push(doc.data()));
                localStorage.setItem('akrabloko_cats', JSON.stringify(cats)); localStorage.setItem('akrabloko_cats_time', Date.now());
                renderCats(cats, defaultHtml);
            } catch(e) { if(cachedCats) renderCats(JSON.parse(cachedCats), defaultHtml); else container.innerHTML = defaultHtml; }
        };
        function renderCats(cats, defaultHtml) {
            let html = defaultHtml; cats.forEach(c => html += `<button onclick="filterProducts('${c.slug}')" class="category-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold transition-all whitespace-nowrap hover:bg-gray-700 ml-2"><i class="fas ${c.icon||'fa-tag'} mr-1"></i> ${c.name}</button>`);
            document.getElementById('categories-container').innerHTML = html;
        }

        window.fetchProducts = async function() {
            const grid = document.getElementById('products-grid');
            const cachedData = localStorage.getItem('akrabloko_products');
            if (cachedData && (Date.now() - localStorage.getItem('akrabloko_time') < 3600000)) { products = JSON.parse(cachedData); renderProducts(products); return; }
            try {
                const q = query(collection(db, "products"), orderBy("category"));
                const snapshot = await getDocs(q);
                products = []; snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
                localStorage.setItem('akrabloko_products', JSON.stringify(products)); localStorage.setItem('akrabloko_time', Date.now());
                renderProducts(products);
            } catch (error) { if (cachedData) { products = JSON.parse(cachedData); renderProducts(products); } else grid.innerHTML = '<div class="text-center text-red-500">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>'; }
        };
        window.renderProducts = (items) => {
            const grid = document.getElementById('products-grid');
            if(items.length===0) return grid.innerHTML='<div class="col-span-full text-center text-gray-500 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª.</div>';
            grid.innerHTML = items.map(p => `
                <div onclick="openVariantModal('${p.id}')" class="bg-gray-900 rounded-2xl p-3 neon-box flex flex-col justify-between h-full relative overflow-hidden group cursor-pointer">
                    <div class="w-full h-56 rounded-xl bg-gray-800 mb-3 overflow-hidden relative border border-gray-800">
                        <img src="${p.coverImage || p.icon}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='https://placehold.co/400x400/111/444?text=No+Image'">
                        <div class="absolute bottom-2 right-2 w-8 h-8 rounded-lg bg-neonPink text-white flex items-center justify-center shadow-lg z-10"><i class="fas fa-plus text-xs"></i></div>
                    </div>
                    <div><h3 class="font-bold text-gray-100 text-sm mb-1 line-clamp-1 text-right">${p.name}</h3><p class="text-[10px] text-gray-400 line-clamp-1 mb-2">${p.desc || 'Ø®Ø§Ù…Ø© Ù…Ù…ØªØ§Ø²Ø© - Ù‚Ø·Ù† 100%'}</p><div class="flex items-center justify-between w-full mt-1"><span class="text-neonBlue font-black text-lg">${p.price} <span class="text-[9px] text-gray-400">Ø¬.Ù…</span></span></div></div>
                </div>`).join('');
        };

        // Modal Logic
        window.openVariantModal = (pid) => {
            const p = products.find(x => x.id === pid); selectedProduct = p; selectedSize = null; selectedColor = null;
            document.getElementById('modal-title').innerText = p.name;
            document.getElementById('modal-price').innerText = p.price + ' Ø¬.Ù…';
            document.getElementById('modal-desc').innerText = p.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ.';
            
            // Render Images (Ù‡Ù†Ø§ ØªØ¸Ù‡Ø± Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØµØºØ±Ø©/Ø§Ù„ØµÙˆØ± Ø§Ù„Ø§Ø¶Ø§ÙÙŠØ©)
            let imgs = [p.coverImage || p.icon]; if(p.extraImages && Array.isArray(p.extraImages)) imgs = imgs.concat(p.extraImages);
            document.getElementById('modal-images').innerHTML = imgs.map(img => `<img src="${img}" class="w-64 h-80 object-cover rounded-xl snap-center border border-gray-800 flex-shrink-0 bg-gray-800">`).join('');
            
            const sizes = (p.sizes && p.sizes.length > 0) ? p.sizes : ['Free Size']; 
            document.getElementById('modal-sizes').innerHTML = sizes.map(s => `<label class="cursor-pointer"><input type="radio" name="size_opt" value="${s}" class="option-input sr-only" onchange="selectSize('${s}')"><div class="bg-gray-800 text-gray-400 border border-gray-700 px-4 py-2 rounded-lg text-sm font-bold transition hover:bg-gray-700 uppercase min-w-[50px] text-center">${s}</div></label>`).join('');
            document.getElementById('size-label').innerText = '';
            
            const colors = (p.colors && p.colors.length > 0) ? p.colors : ['Standard'];
            document.getElementById('modal-colors').innerHTML = colors.map(c => `<label class="cursor-pointer"><input type="radio" name="color_opt" value="${c}" class="option-input color-input sr-only" onchange="selectColor('${c}')"><div class="bg-gray-800 text-gray-400 border border-gray-700 px-4 py-2 rounded-lg text-sm font-bold transition hover:bg-gray-700 min-w-[60px] text-center">${c}</div></label>`).join('');
            document.getElementById('color-label').innerText = '';
            
            const btn = document.getElementById('add-to-cart-btn');
            btn.innerHTML = `<span>Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³ ÙˆØ§Ù„Ù„ÙˆÙ†</span> <i class="fas fa-hand-point-up"></i>`; btn.className = "w-full bg-gray-800 text-gray-500 font-bold py-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 cursor-not-allowed"; btn.disabled = true;
            document.getElementById('variant-modal').classList.remove('hidden');
        };

        window.selectSize = (s) => { selectedSize = s; document.getElementById('size-label').innerText = s; checkBtnState(); }
        window.selectColor = (c) => { selectedColor = c; document.getElementById('color-label').innerText = c; checkBtnState(); }
        window.checkBtnState = () => {
            const btn = document.getElementById('add-to-cart-btn');
            if(selectedSize && selectedColor) {
                btn.disabled = false; btn.className = "w-full bg-neonPink text-white font-bold py-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 hover:bg-purple-600";
                btn.innerHTML = `<span>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</span> <i class="fas fa-cart-plus"></i>`;
            }
        };
        window.confirmAddToCart = () => {
            const cartItemId = `${selectedProduct.id}-${selectedSize}-${selectedColor}`;
            const exists = cart.find(i => i.cartItemId === cartItemId);
            if(exists) exists.qty++; else cart.push({ cartItemId, id: selectedProduct.id, name: `${selectedProduct.name} (${selectedSize}|${selectedColor})`, price: selectedProduct.price, qty: 1, image: selectedProduct.coverImage });
            saveCart(); updateCartUI();
            const btn = document.getElementById('add-to-cart-btn');
            btn.className = "w-full bg-green-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2";
            btn.innerHTML = `<span>ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…</span>`;
            setTimeout(() => { closeVariantModal(); }, 1000);
        };
        window.closeVariantModal = () => document.getElementById('variant-modal').classList.add('hidden');

        // Cart & Checkout
        window.toggleCart = () => document.getElementById('cart-modal').classList.toggle('hidden');
        window.clearCart = () => { cart = []; saveCart(); updateCartUI(); };
        window.saveCart = () => localStorage.setItem('akrabloko_cart', JSON.stringify(cart));
        window.updateCartUI = () => {
            const count = cart.reduce((a, b) => a + b.qty, 0);
            const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('cart-counter').innerText = count; document.getElementById('cart-total').innerText = total + ' Ø¬.Ù…'; document.getElementById('modal-total-price').innerText = total + ' Ø¬.Ù…';
            const container = document.getElementById('cart-items');
            if(cart.length===0) container.innerHTML = `<div class="text-center text-gray-500 py-10 flex flex-col items-center"><i class="fas fa-shopping-bag text-4xl mb-3 opacity-20"></i>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>`;
            else container.innerHTML = cart.map(item => `<div class="flex justify-between items-center bg-gray-900 p-3 rounded-xl border border-gray-800"><div class="flex flex-col"><h4 class="font-bold text-white text-xs mb-1 line-clamp-1">${item.name}</h4><span class="text-[10px] text-neonBlue font-bold">${item.price} Ø¬.Ù…</span></div><div class="flex items-center gap-2 bg-black rounded-lg px-2 py-1"><button onclick="changeQty('${item.cartItemId}', -1)" class="text-gray-400 hover:text-white px-1 font-bold">-</button><span class="font-bold text-xs w-4 text-center text-white">${item.qty}</span><button onclick="changeQty('${item.cartItemId}', 1)" class="text-green-400 hover:text-white px-1 font-bold">+</button></div></div>`).join('');
        };
        window.changeQty = (id, delta) => { const item = cart.find(i => i.cartItemId === id); if(item) { item.qty += delta; if(item.qty <= 0) cart = cart.filter(i => i.cartItemId !== id); saveCart(); updateCartUI(); } };
        window.openCheckoutModal = () => { if(cart.length === 0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!'); toggleCart(); document.getElementById('checkout-modal').classList.remove('hidden'); };
        window.closeCheckoutModal = () => document.getElementById('checkout-modal').classList.add('hidden');
        
        // --- Order Submission (Fixed Crash Issue) ---
        window.submitOrder = async () => {
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            const btn = document.querySelector('#checkout-form button');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...'; btn.disabled = true;
            try {
                // 1. Sanitize Data (Ù…Ù†Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙŠØ¨Ø©)
                const sanitizedCart = cart.map(item => ({
                    cartItemId: item.cartItemId, id: item.id, name: item.name, price: item.price, qty: item.qty
                }));

                const orderNum = Math.floor(100000 + Math.random() * 900000);
                
                // 2. Timeout Protection (Ù„Ùˆ Ø§Ù„Ù†Øª Ø¨Ø·ÙŠØ¡)
                await addDoc(collection(db, "orders"), {
                    orderNum, customer: { name, phone, address }, items: sanitizedCart,
                    total: cart.reduce((a, b) => a + (b.price * b.qty), 0),
                    status: "new", timestamp: serverTimestamp(), date: new Date().toLocaleString('ar-EG')
                });
                
                document.getElementById('success-order-num').innerText = orderNum;
                document.getElementById('success-modal').classList.remove('hidden');
                localStorage.setItem('akrabloko_user', JSON.stringify({ name, phone, address }));
            } catch (error) { 
                console.error(error);
                alert("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±!\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); 
            }
            finally { 
                btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€'; btn.disabled = false; 
            }
        };

        window.closeSuccessModal = () => {
            document.getElementById('success-modal').classList.add('hidden');
            clearCart(); 
            closeCheckoutModal();
        };

        window.openTrackModal = () => { document.getElementById('track-modal').classList.remove('hidden'); document.getElementById('track-result').classList.add('hidden'); };
        window.closeTrackModal = () => document.getElementById('track-modal').classList.add('hidden');
        window.trackOrder = async () => {
            const input = document.getElementById('track-input').value; const resultDiv = document.getElementById('track-result'); if(!input) return; resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin text-neonBlue"></i>'; resultDiv.classList.remove('hidden');
            try {
                const q = query(collection(db, "orders"), where("orderNum", "==", parseInt(input))); const s = await getDocs(q);
                if (s.empty) resultDiv.innerHTML = '<p class="text-red-500">âŒ Ø±Ù‚Ù… Ø®Ø·Ø£</p>';
                else s.forEach((doc) => { const o = doc.data(); let msg='', color=''; if(o.status==='new') {msg='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ² ğŸ‘”'; color='text-yellow-400';} else if(o.status==='shipping') {msg='Ø®Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„ ğŸ›µ'; color='text-neonBlue';} else {msg='ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ âœ…'; color='text-green-500';} resultDiv.innerHTML = `<div class="text-center"><p class="text-gray-400 text-sm mb-1">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${o.orderNum}</p><h3 class="text-2xl font-black ${color}">${msg}</h3></div>`; });
            } catch (e) { resultDiv.innerHTML = '<p class="text-red-500">Ø®Ø·Ø£ Ù†Øª</p>'; }
        };
        window.filterProducts = (cat) => { document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active')); if(event) event.currentTarget.classList.add('active'); if(cat === 'all') renderProducts(products); else renderProducts(products.filter(p => p.category === cat)); };
        window.searchProducts = () => { renderProducts(products.filter(p => p.name.toLowerCase().includes(document.getElementById('searchInput').value.toLowerCase()))); };
        window.addEventListener('DOMContentLoaded', () => { fetchCategories(); fetchProducts(); updateCartUI(); const u=JSON.parse(localStorage.getItem('akrabloko_user')); if(u){document.getElementById('customer-name').value=u.name||'';document.getElementById('customer-phone').value=u.phone||'';document.getElementById('customer-address').value=u.address||'';} });
    </script>
</body>
</html>
