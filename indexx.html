<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="images/logo.png" type="image/png">
    <meta property="og:image" content="https://akrabloko.vercel.app/images/banner.jpg">
    <meta property="og:title" content="Ø£Ù‚Ø±Ø¨Ù„ÙˆÙƒÙˆ - Ù…Ø§Ø±ÙƒØª Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ù‚Ø±Ø¨Ù„ÙˆÙƒÙˆ | Akrabloko Store</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { neonBlue: '#00f3ff', neonPink: '#bc13fe', neonGreen: '#39ff14', darkBg: '#050505', cardBg: '#111111' },
                    fontFamily: { cairo: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #050505; color: #fff; -webkit-tap-highlight-color: transparent; }
        .neon-box { border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); transition: all 0.3s; }
        .neon-box:hover { border-color: #bc13fe; box-shadow: 0 0 15px rgba(188, 19, 254, 0.3); transform: translateY(-4px); }
        .category-btn.active { background: linear-gradient(135deg, #bc13fe, #6a00ff); color: white; box-shadow: 0 0 15px rgba(188, 19, 254, 0.5); border: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; transition: all 0.3s; }
        .custom-input:focus { outline: none; border-color: #00f3ff; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00f3ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
    </style>
</head>
<body class="pb-32 relative">

    <nav class="fixed top-0 w-full z-50 bg-black/90 backdrop-blur-xl border-b border-white/10 shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="text-2xl font-black flex items-center gap-1">
                    <span class="text-white">Ø£Ù‚Ø±Ø¨</span><span class="text-neonPink" style="text-shadow: 0 0 8px #bc13fe;">Ù„ÙˆÙƒÙˆ</span>
                </div>
                <button onclick="openTrackModal()" class="mr-2 text-[10px] font-bold text-neonBlue border border-neonBlue/30 bg-neonBlue/10 px-3 py-1.5 rounded-full flex items-center gap-1 hover:bg-neonBlue/20 transition">
                    <i class="fas fa-search-location"></i> ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
                </button>
            </div>
            <div class="flex items-center gap-2 bg-gray-900 border border-gray-700 rounded-full px-3 py-1">
                <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                <span class="text-[10px] font-bold text-gray-300">Ù…ÙØªÙˆØ­ 24H</span>
            </div>
        </div>
    </nav>

    <header class="relative mt-20 mb-6 px-4 text-center">
        <div class="bg-gradient-to-b from-gray-900 to-black rounded-3xl p-6 border border-gray-800 relative overflow-hidden">
            <h1 class="text-2xl md:text-3xl font-black mb-2 text-white">Ø£Ù‚Ø±Ø¨ Ù…Ø§Ø±ÙƒØª <span class="text-neonBlue">Ù„Ø¯Ù…Ø§ØºÙƒ</span> ğŸš€</h1>
            <p class="text-gray-400 text-xs md:text-sm max-w-md mx-auto">Ù…Ù† Ø§Ù„Ø¥Ø¨Ø±Ø© Ù„Ù„ØµØ§Ø±ÙˆØ®.. Ù…Ø²Ø§Ø¬Ùƒ ÙˆØ·Ù„Ø¨Ø§Øª Ø¨ÙŠØªÙƒ ØªÙˆØµÙ„Ùƒ ÙÙŠ Ø«ÙˆØ§Ù†ÙŠ.</p>
        </div>
    </header>

    <section class="container mx-auto px-3 md:px-4 mb-12">
        <div class="relative mb-6 group">
            <input type="text" id="searchInput" onkeyup="searchProducts()" placeholder="Ø¹Ø§ÙŠØ² Ø¨Ù†ØŒ Ø¥Ù†Ø¯ÙˆÙ…ÙŠØŒ Ø³Ø¬Ø§ÙŠØ±ØŸ" class="w-full bg-gray-900/80 border border-gray-700 text-white rounded-2xl py-3.5 px-11 focus:outline-none focus:border-neonBlue transition duration-300">
            <i class="fas fa-search absolute right-4 top-4 text-gray-500 group-focus-within:text-neonBlue transition-colors"></i>
        </div>

        <div class="sticky top-[60px] z-40 bg-[#050505]/95 backdrop-blur-sm py-2 mb-2 -mx-4 px-4 border-b border-white/5">
            <div class="flex overflow-x-auto gap-2 no-scrollbar pb-1">
                <button onclick="filterProducts('all')" class="category-btn active px-4 py-2 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold transition-all">Ø§Ù„ÙƒÙ„</button>
                <button onclick="filterProducts('grocery')" class="category-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold transition-all"><i class="fas fa-shopping-basket mr-1"></i> Ø§Ù„Ø¨Ù‚Ø§Ù„Ø©</button>
                <button onclick="filterProducts('snacks')" class="category-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold transition-all"><i class="fas fa-cookie-bite mr-1"></i> Ù†Ù‚Ù†Ù‚Ø©</button>
                <button onclick="filterProducts('drinks')" class="category-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold transition-all"><i class="fas fa-wine-bottle mr-1"></i> Ù…Ø´Ø±ÙˆØ¨Ø§Øª</button>
                <button onclick="filterProducts('mood')" class="category-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold transition-all"><i class="fas fa-smoking mr-1"></i> Ø§Ù„Ù…Ø²Ø§Ø¬</button>
            </div>
        </div>

        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4 mb-8"></div>
    </section>

    <footer class="bg-black border-t border-gray-800 py-8 mt-auto relative z-10 text-center">
        <div class="container mx-auto px-4">
            <h2 class="text-2xl font-black text-white mb-2">Ø£Ù‚Ø±Ø¨<span class="text-neonPink">Ù„ÙˆÙƒÙˆ</span></h2>
            <p class="text-gray-500 text-sm mb-4">Ø®Ø¯Ù…Ø© ØªÙˆØµÙŠÙ„ 24 Ø³Ø§Ø¹Ø© - Ø£Ø³Ø±Ø¹ Ø¯Ù„ÙŠÙØ±ÙŠ ÙÙŠ Ù…ØµØ±</p>
            <div class="border-t border-gray-800 pt-6">
                <p class="text-neonBlue font-bold text-lg mb-1"><i class="fas fa-phone-alt mr-2"></i> 01000000000</p>
                <p class="text-gray-600 text-xs">Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ Ø£Ù‚Ø±Ø¨Ù„ÙˆÙƒÙˆ</p>
            </div>
        </div>
    </footer>

    <div class="fixed bottom-5 left-4 right-4 z-40 max-w-lg mx-auto">
        <button onclick="toggleCart()" class="w-full bg-gray-900 border border-neonPink/50 text-white rounded-2xl shadow-[0_4px_20px_rgba(188,19,254,0.3)] overflow-hidden group">
            <div class="bg-gradient-to-r from-neonPink/10 to-purple-900/20 backdrop-blur-md py-3 px-5 flex justify-between items-center h-full">
                <div class="flex items-center gap-3">
                    <div class="bg-neonPink text-white font-black w-8 h-8 rounded-lg flex items-center justify-center shadow-lg" id="cart-counter">0</div>
                    <div class="flex flex-col items-start"><span class="font-bold text-sm">Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span><span class="text-[10px] text-gray-400">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ·Ù„Ø¨</span></div>
                </div>
                <span class="font-black text-lg text-neonBlue" id="cart-total">0 Ø¬.Ù…</span>
            </div>
        </button>
    </div>

    <div id="track-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeTrackModal()"></div>
        <div class="bg-black/70 backdrop-blur-xl w-full max-w-md rounded-2xl border border-white/10 relative overflow-hidden shadow-2xl p-6 text-center">
            <h2 class="text-xl font-black text-white mb-2">ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</h2>
            <input type="number" id="track-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨" class="custom-input bg-white/5 border-white/10 text-center text-lg font-bold tracking-widest text-white mb-4">
            <button onclick="trackOrder()" class="w-full bg-neonBlue text-black font-bold py-3 rounded-xl mb-4">Ø¨Ø­Ø«</button>
            <div id="track-result" class="hidden bg-black/40 p-4 rounded-xl border border-white/5 mt-4"></div>
            <button onclick="closeTrackModal()" class="absolute top-4 left-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
        </div>
    </div>

    <div id="variant-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeVariantModal()"></div>
        <div class="bg-black/70 backdrop-blur-xl w-full max-w-sm rounded-3xl border border-white/10 relative overflow-hidden flex flex-col max-h-[80vh] shadow-2xl">
            <div class="p-5 text-center"><h3 id="modal-product-name" class="text-xl font-bold text-white mb-1"></h3></div>
            <div id="variant-options" class="grid grid-cols-2 gap-2 p-4 pt-0 overflow-y-auto custom-scrollbar"></div>
            <div class="p-4 border-t border-white/10"><button onclick="closeVariantModal()" class="w-full bg-white/10 text-white py-3 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button></div>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCheckoutModal()"></div>
        <div class="bg-black/70 backdrop-blur-xl w-full max-w-md rounded-2xl border border-white/10 relative p-6 shadow-2xl">
            <h2 class="text-2xl font-black text-white mb-2 text-center">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ğŸ›µ</h2>
            <form id="checkout-form" onsubmit="event.preventDefault(); submitOrder();">
                <input type="text" id="customer-name" class="custom-input bg-white/5 border-white/10" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
                <input type="tel" id="customer-phone" class="custom-input bg-white/5 border-white/10" placeholder="01xxxxxxxxx" maxlength="11" required>
                <textarea id="customer-address" class="custom-input bg-white/5 border-white/10 h-24" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" required></textarea>
                <button type="submit" class="w-full bg-gradient-to-r from-neonPink to-purple-800 text-white font-bold py-4 rounded-xl shadow-lg">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
            </form>
            <button onclick="closeCheckoutModal()" class="absolute top-4 left-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
        </div>
    </div>

    <div id="cart-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleCart()"></div>
        <div class="absolute bottom-0 w-full bg-black/80 backdrop-blur-xl rounded-t-3xl border-t border-white/10 max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 flex justify-between items-center border-b border-white/10">
                <h2 class="text-lg font-bold text-white">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
                <button onclick="clearCart()" class="text-red-400 text-xs px-3 py-1.5 bg-red-500/10 rounded-full border border-red-500/20">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
            </div>
            <div id="cart-items" class="p-4 overflow-y-auto flex-1 space-y-3 custom-scrollbar"></div>
            <div class="p-5 bg-black/40 border-t border-white/10 pb-8">
                <div class="flex justify-between items-center mb-4 text-lg font-bold"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span class="text-neonBlue text-xl" id="modal-total-price">0 Ø¬.Ù…</span></div>
                <button onclick="openCheckoutModal()" class="w-full bg-[#25D366] text-white font-bold py-3.5 rounded-xl">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUgMCQPD3LqQHhiJqGUykCvi4GkqIxBDg",
            authDomain: "akrabloko.firebaseapp.com",
            projectId: "akrabloko",
            storageBucket: "akrabloko.firebasestorage.app",
            messagingSenderId: "846428093028",
            appId: "1:846428093028:web:29f31599b90125c2673d71",
            measurementId: "G-31SP9TP2N1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let products = []; // Ø§Ù„Ù„ÙŠØ³ØªÙ‡ Ø¨Ù‚Øª ÙØ§Ø¶ÙŠØ© ÙˆÙ‡ØªØªÙ…Ù„ÙŠ Ù…Ù† Ø§Ù„Ù†Øª
        let cart = JSON.parse(localStorage.getItem('akrabloko_cart')) || [];
        window.currentSelectedProduct = null;

        // --- STARTUP LOGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            fetchProducts(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙˆØ±Ø§Ù‹
            updateCartUI();
            
            const savedData = JSON.parse(localStorage.getItem('akrabloko_user'));
            if(savedData) {
                document.getElementById('customer-name').value = savedData.name || '';
                document.getElementById('customer-phone').value = savedData.phone || '';
                document.getElementById('customer-address').value = savedData.address || '';
            }
        });

        // --- FETCH PRODUCTS (NEW) ---
        window.fetchProducts = async function() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '<div class="col-span-full text-center py-10"><div class="loader"></div><p class="text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ÙŠÙˆ...</p></div>';

            try {
                const q = query(collection(db, "products"), orderBy("category"));
                const snapshot = await getDocs(q);
                products = [];
                snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
                
                if(products.length === 0) grid.innerHTML = '<div class="col-span-full text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
                else renderProducts(products);
            } catch (error) {
                console.error(error);
                grid.innerHTML = '<div class="col-span-full text-center text-red-500 p-5">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª<br><button onclick="fetchProducts()" class="mt-2 text-neonBlue underline">Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ</button></div>';
            }
        }

        // --- RENDER LOGIC ---
        window.renderProducts = (items) => {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = items.map(p => `
                <div class="bg-gray-900 rounded-2xl p-4 neon-box flex flex-col items-center justify-between text-center h-full relative overflow-hidden group">
                    <div class="w-14 h-14 rounded-full bg-gray-800 flex items-center justify-center mb-3 border border-gray-700 group-hover:border-neonBlue transition shadow-lg relative z-10">
                        <i class="fas ${p.icon} ${p.color || 'text-white'} text-2xl group-hover:scale-110 transition"></i>
                    </div>
                    <div class="relative z-10 w-full">
                        <h3 class="font-bold text-gray-100 text-sm mb-1 line-clamp-1">${p.name}</h3>
                        <span class="text-[10px] text-gray-500 font-bold bg-black/50 px-2 py-0.5 rounded-full inline-block mb-3">${p.desc || p.category}</span>
                        <div class="flex items-center justify-between w-full bg-black/30 rounded-xl p-1 pr-3 border border-gray-800">
                            <span class="text-neonBlue font-black text-sm">${p.price} <span class="text-[9px] text-gray-400">Ø¬.Ù…</span></span>
                            <button onclick="prepareAddToCart('${p.id}')" class="w-7 h-7 rounded-lg bg-neonPink text-white flex items-center justify-center hover:bg-purple-500 transition shadow-lg active:scale-90">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        // --- FILTERS & SEARCH ---
        window.filterProducts = (cat) => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(cat === 'all') renderProducts(products);
            else renderProducts(products.filter(p => p.category === cat));
        };

        window.searchProducts = () => {
            const query = document.getElementById('searchInput').value.toLowerCase();
            renderProducts(products.filter(p => p.name.toLowerCase().includes(query)));
        };

        // --- CART LOGIC ---
        window.prepareAddToCart = (id) => {
            const product = products.find(p => p.id === id);
            if (product.variants && product.variants.length > 0) openVariantModal(product);
            else addToCart(product, null);
        };

        window.openVariantModal = (product) => {
            window.currentSelectedProduct = product;
            document.getElementById('modal-product-name').innerText = product.name;
            const container = document.getElementById('variant-options');
            container.innerHTML = product.variants.map(variant => `
                <button onclick="selectVariant('${variant}')" class="bg-gray-800 hover:bg-neonBlue hover:text-black text-gray-200 py-3 px-2 rounded-xl text-xs font-bold transition border border-gray-700 h-14">
                    ${variant}
                </button>`).join('');
            document.getElementById('variant-modal').classList.remove('hidden');
        };
        window.closeVariantModal = () => { document.getElementById('variant-modal').classList.add('hidden'); window.currentSelectedProduct = null; };
        window.selectVariant = (v) => { if(window.currentSelectedProduct) { addToCart(window.currentSelectedProduct, v); closeVariantModal(); } };

        window.addToCart = (product, variant) => {
            const cartItemId = variant ? `${product.id}-${variant}` : `${product.id}`;
            const displayName = variant ? `${product.name} (${variant})` : product.name;
            const exists = cart.find(i => i.cartItemId === cartItemId);
            if(exists) exists.qty++; else cart.push({ cartItemId, id: product.id, name: displayName, price: product.price, qty: 1 });
            saveCart(); updateCartUI(); if(navigator.vibrate) navigator.vibrate(50);
        };

        window.changeQty = (id, delta) => {
            const item = cart.find(i => i.cartItemId === id);
            if(item) { item.qty += delta; if(item.qty <= 0) cart = cart.filter(i => i.cartItemId !== id); saveCart(); updateCartUI(); }
        };

        window.clearCart = () => { cart = []; saveCart(); updateCartUI(); };
        window.saveCart = () => localStorage.setItem('akrabloko_cart', JSON.stringify(cart));
        window.updateCartUI = () => {
            const count = cart.reduce((a, b) => a + b.qty, 0);
            const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('cart-counter').innerText = count;
            document.getElementById('cart-total').innerText = total + ' Ø¬.Ù…';
            document.getElementById('modal-total-price').innerText = total + ' Ø¬.Ù…';
            const container = document.getElementById('cart-items');
            if(cart.length===0) container.innerHTML = '<div class="text-center text-gray-500 py-10">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
            else container.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center bg-gray-900 p-3 rounded-xl border border-gray-800">
                    <div class="flex flex-col"><h4 class="font-bold text-white text-xs">${item.name}</h4><span class="text-[10px] text-neonBlue font-bold">${item.price} Ø¬.Ù…</span></div>
                    <div class="flex items-center gap-2 bg-black rounded-lg px-2"><button onclick="changeQty('${item.cartItemId}', -1)" class="text-gray-400 px-1">-</button><span class="text-white text-xs">${item.qty}</span><button onclick="changeQty('${item.cartItemId}', 1)" class="text-green-400 px-1">+</button></div>
                </div>`).join('');
        };
        window.toggleCart = () => document.getElementById('cart-modal').classList.toggle('hidden');

        // --- CHECKOUT & ORDER ---
        window.openCheckoutModal = () => { if(cart.length===0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©!'); toggleCart(); document.getElementById('checkout-modal').classList.remove('hidden'); };
        window.closeCheckoutModal = () => document.getElementById('checkout-modal').classList.add('hidden');

        window.submitOrder = async () => {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const address = document.getElementById('customer-address').value.trim();
            
            if(!name || !phone || !address) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
            localStorage.setItem('akrabloko_user', JSON.stringify({ name, phone, address }));

            const btn = document.querySelector('#checkout-form button');
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...'; btn.disabled = true;
            const orderNum = Math.floor(100000 + Math.random() * 900000);

            try {
                await addDoc(collection(db, "orders"), {
                    orderNum, customer: { name, phone, address }, items: cart,
                    total: cart.reduce((a, b) => a + (b.price * b.qty), 0),
                    status: "new", timestamp: serverTimestamp(), date: new Date().toLocaleString('ar-EG')
                });
                alert(`âœ… ØªÙ… Ø§Ù„Ø·Ù„Ø¨! ÙƒÙˆØ¯: ${orderNum}`);
                clearCart(); closeCheckoutModal();
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!"); }
            btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€'; btn.disabled = false;
        };

        // --- TRACKING ---
        window.openTrackModal = () => { document.getElementById('track-modal').classList.remove('hidden'); document.getElementById('track-result').classList.add('hidden'); };
        window.closeTrackModal = () => document.getElementById('track-modal').classList.add('hidden');
        window.trackOrder = async () => {
            const input = document.getElementById('track-input').value;
            const res = document.getElementById('track-result');
            if(!input) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù…!');
            res.classList.remove('hidden'); res.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
            try {
                const q = query(collection(db, "orders"), where("orderNum", "==", parseInt(input)));
                const s = await getDocs(q);
                if(s.empty) res.innerHTML = '<p class="text-red-500">Ø±Ù‚Ù… ØºÙ„Ø·!</p>';
                else {
                    const o = s.docs[0].data();
                    res.innerHTML = `<h3 class="text-xl font-bold ${o.status==='new'?'text-yellow-400':'text-green-500'}">${o.status==='new'?'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²':'ÙˆØµÙ„'}</h3>`;
                }
            } catch(e) { res.innerHTML = 'Ø®Ø·Ø£ Ù†Øª'; }
        };
    </script>
</body>
</html>
