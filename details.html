<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل المنتج | Akrabloko Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { theme: { extend: { colors: { neonBlue: '#00f3ff', neonPink: '#bc13fe', darkBg: '#050505' }, fontFamily: { cairo: ['Cairo', 'sans-serif'] } } } }
    </script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #050505; color: #fff; min-height: 100vh; padding-bottom: 20px; }
        .glass-panel { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .option-input:checked + div { background: #bc13fe; color: white; border-color: #bc13fe; box-shadow: 0 0 10px rgba(188, 19, 254, 0.4); transform: scale(1.05); }
        .thumb-active { border-color: #00f3ff !important; opacity: 1 !important; }
    </style>
</head>
<body>

    <a href="index.html" class="fixed top-4 right-4 z-50 bg-black/60 backdrop-blur-md p-3 rounded-full border border-white/10 hover:bg-neonBlue hover:text-black transition shadow-xl">
        <i class="fas fa-arrow-right text-xl"></i>
    </a>

    <div id="loading" class="text-center mt-40 text-gray-500 animate-pulse">
        <i class="fas fa-circle-notch fa-spin text-4xl mb-4 text-neonBlue"></i><br>جاري تحميل الصور...
    </div>

    <div id="product-container" class="container mx-auto px-4 pt-4 hidden animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="space-y-4">
                <div class="aspect-[4/5] rounded-3xl overflow-hidden border border-white/10 bg-[#111] relative">
                    <img id="main-img" src="" class="w-full h-full object-cover transition duration-500">
                </div>
                
                <div id="thumbnails-container" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    </div>
            </div>

            <div class="glass-panel p-6 rounded-3xl h-fit">
                <h1 id="p-name" class="text-2xl font-black mb-2 leading-tight"></h1>
                <p id="p-price" class="text-3xl font-bold text-neonBlue mb-6"></p>
                <p id="p-desc" class="text-gray-400 text-sm leading-relaxed mb-6 border-b border-white/5 pb-4"></p>

                <div class="mb-4">
                    <p class="text-xs text-gray-500 font-bold mb-2">اختر المقاس:</p>
                    <div id="sizes-container" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="mb-6">
                    <p class="text-xs text-gray-500 font-bold mb-2">اختر اللون:</p>
                    <div id="colors-container" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="flex items-center justify-between mb-8 bg-black/30 p-3 rounded-xl border border-white/5">
                    <span class="text-sm font-bold text-gray-400">الكمية:</span>
                    <div class="flex items-center gap-4">
                        <button onclick="updateQty(-1)" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20">-</button>
                        <span id="qty-display" class="font-black text-xl text-white">1</span>
                        <button onclick="updateQty(1)" class="w-8 h-8 rounded-lg bg-neonBlue/20 text-neonBlue hover:bg-neonBlue/30">+</button>
                    </div>
                </div>

                <button id="add-btn" onclick="addToCartAndReturn()" disabled class="w-full bg-[#222] text-gray-500 font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 cursor-not-allowed">
                    <span>اختر المقاس واللون أولاً</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCUgMCQPD3LqQHhiJqGUykCvi4GkqIxBDg", authDomain: "akrabloko.firebaseapp.com", projectId: "akrabloko", storageBucket: "akrabloko.firebasestorage.app", messagingSenderId: "846428093028", appId: "1:846428093028:web:29f31599b90125c2673d71" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentProduct = null;
        let selectedSize = null;
        let selectedColor = null;
        let qty = 1;

        // 1. تشغيل الصفحة
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');
        if (!productId) window.location.href = 'index.html';
        else loadProduct(productId);

        async function loadProduct(id) {
            try {
                const docSnap = await getDoc(doc(db, "products", id));
                if (docSnap.exists()) {
                    const p = docSnap.data();
                    currentProduct = { id: docSnap.id, ...p };

                    // تعبئة البيانات الأساسية
                    document.title = p.name;
                    document.getElementById('p-name').innerText = p.name;
                    document.getElementById('p-price').innerText = `${p.price} ج.م`;
                    document.getElementById('p-desc').innerText = p.desc;
                    
                    // --- [تعديل الصور] ---
                    // تحديد الصورة الرئيسية
                    const mainImg = document.getElementById('main-img');
                    mainImg.src = p.coverImage;

                    // إنشاء المعرض (نتأكد هل فيه صور إضافية ولا لأ)
                    // نجمع صورة الغلاف + الصور الإضافية في مصفوفة واحدة
                    const allImages = [p.coverImage, ...(p.images || [])];
                    
                    // عرض الصور المصغرة
                    const thumbsContainer = document.getElementById('thumbnails-container');
                    thumbsContainer.innerHTML = allImages.map((imgUrl, index) => `
                        <img src="${imgUrl}" 
                             onclick="changeMainImage('${imgUrl}', this)" 
                             class="w-16 h-20 object-cover rounded-lg border-2 border-transparent cursor-pointer hover:border-white/50 transition ${index===0 ? 'thumb-active' : ''}">
                    `).join('');

                    window.changeMainImage = (url, thumb) => {
                        mainImg.src = url;
                        // تحديث الإطار المضيء
                        document.querySelectorAll('#thumbnails-container img').forEach(i => i.classList.remove('thumb-active'));
                        thumb.classList.add('thumb-active');
                    };
                    // ---------------------

                    // المقاسات والألوان
                    const sizes = p.sizes || ['Free Size'];
                    document.getElementById('sizes-container').innerHTML = sizes.map(s => `
                        <label class="cursor-pointer">
                            <input type="radio" name="size" value="${s}" class="option-input sr-only" onchange="setSize('${s}')">
                            <div class="bg-black border border-gray-700 px-3 py-2 rounded-lg text-xs font-bold text-gray-300 transition select-none">${s}</div>
                        </label>`).join('');

                    const colors = p.colors || ['Standard'];
                    document.getElementById('colors-container').innerHTML = colors.map(c => `
                        <label class="cursor-pointer">
                            <input type="radio" name="color" value="${c}" class="option-input sr-only" onchange="setColor('${c}')">
                            <div class="bg-black border border-gray-700 px-3 py-2 rounded-lg text-xs font-bold text-gray-300 transition select-none">${c}</div>
                        </label>`).join('');

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('product-container').classList.remove('hidden');
                }
            } catch (e) { console.error(e); }
        }

        // دوال المساعدة
        window.setSize = (s) => { selectedSize = s; checkBtn(); };
        window.setColor = (c) => { selectedColor = c; checkBtn(); };
        window.updateQty = (n) => { qty += n; if(qty < 1) qty = 1; document.getElementById('qty-display').innerText = qty; };

        function checkBtn() {
            const btn = document.getElementById('add-btn');
            if (selectedSize && selectedColor) {
                btn.disabled = false;
                btn.className = "w-full bg-neonPink text-white font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(188,19,254,0.4)] hover:scale-[1.02] transition cursor-pointer";
                btn.innerHTML = `إضافة للسلة والعودة <i class="fas fa-check-circle ml-2"></i>`;
            }
        }

        // --- [التعديل الأهم: الإضافة والرجوع للرئيسية] ---
        window.addToCartAndReturn = () => {
            let cart = JSON.parse(localStorage.getItem('akrabloko_cart')) || [];
            
            const cartId = `${currentProduct.id}-${selectedSize}-${selectedColor}`;
            const exists = cart.find(i => i.cartItemId === cartId);
            
            if (exists) exists.qty += qty;
            else cart.push({
                cartItemId: cartId,
                id: currentProduct.id,
                name: `${currentProduct.name} (${selectedSize}|${selectedColor})`,
                price: currentProduct.price,
                qty: qty,
                image: currentProduct.coverImage
            });

            // 1. الحفظ في الذاكرة
            localStorage.setItem('akrabloko_cart', JSON.stringify(cart));

            // 2. تأثير بسيط للزر
            const btn = document.getElementById('add-btn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جاري التحويل...`;
            
            // 3. الرجوع للصفحة الرئيسية فوراً
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500); 
        };
    </script>
</body>
</html>
