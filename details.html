<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="تسوق أفضل المنتجات من أقربلوكو ستور">
    <title>جاري التحميل... | Akrabloko Store</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { neonBlue: '#00f3ff', neonPink: '#bc13fe', darkBg: '#050505' }, 
                    fontFamily: { cairo: ['Cairo', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                } 
            } 
        }
    </script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #050505; color: #fff; min-height: 100vh; padding-bottom: 20px; touch-action: manipulation; }
        .glass-panel { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .option-input:checked + div { background: #bc13fe; color: white; border-color: #bc13fe; box-shadow: 0 0 15px rgba(188, 19, 254, 0.4); transform: scale(1.05); }
        .thumb-active { border-color: #00f3ff !important; opacity: 1 !important; box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); transform: scale(1.05); }
        .dot { height: 8px; width: 8px; background-color: rgba(255,255,255,0.3); border-radius: 50%; display: inline-block; transition: all 0.3s; }
        .dot.active { background-color: #00f3ff; width: 20px; border-radius: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <a href="index.html" class="fixed top-4 right-4 z-50 bg-black/60 backdrop-blur-md p-3 rounded-full border border-white/10 hover:bg-neonBlue hover:text-black transition shadow-xl group">
        <i class="fas fa-arrow-right text-xl group-hover:-translate-x-1 transition-transform"></i>
    </a>

    <div id="loading" class="text-center mt-40 text-gray-500 animate-pulse">
        <div class="relative w-16 h-16 mx-auto mb-4">
            <div class="absolute inset-0 rounded-full border-4 border-neonBlue/20"></div>
            <div class="absolute inset-0 rounded-full border-4 border-t-neonBlue animate-spin"></div>
        </div>
        <p class="font-bold">جاري تحميل المنتج...</p>
    </div>

    <div id="product-container" class="container mx-auto px-4 pt-16 hidden animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            
            <div class="w-full relative select-none">
                <div id="swipe-area" class="aspect-[4/5] w-full rounded-3xl overflow-hidden bg-[#111] border border-white/10 relative shadow-2xl mb-4 touch-pan-y">
                    <img id="main-img" src="" class="w-full h-full object-cover transition duration-500">
                    <div class="absolute bottom-3 right-3 bg-black/60 backdrop-blur px-3 py-1 rounded-full text-xs font-bold border border-white/10">
                        <span id="img-counter">1/1</span> <i class="fas fa-images ml-1 text-gray-400"></i>
                    </div>
                </div>
                <div id="dots-container" class="flex justify-center gap-2 mb-4 h-3"></div>
                <div id="thumbnails-container" class="flex gap-3 overflow-x-auto pb-2 px-1 justify-center scrollbar-hide"></div>
            </div>

            <div class="glass-panel p-6 md:p-8 rounded-3xl h-fit shadow-[0_0_50px_-20px_rgba(188,19,254,0.15)] relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-neonBlue/10 rounded-full blur-3xl -z-10"></div>

                <span id="p-cat" class="text-neonBlue text-xs font-bold bg-neonBlue/10 px-3 py-1 rounded-full mb-3 inline-block border border-neonBlue/20"></span>
                <h1 id="p-name" class="text-2xl md:text-4xl font-black mb-3 leading-tight tracking-wide"></h1>
                <p id="p-price" class="text-4xl font-black text-white mb-6 flex items-end gap-2"><span class="text-neonPink text-lg font-bold mb-1">ج.م</span></p>
                <p id="p-desc" class="text-gray-400 text-sm leading-relaxed mb-8 border-b border-white/5 pb-6"></p>

                <div class="mb-6">
                    <p class="text-xs text-gray-500 font-bold mb-3 uppercase tracking-wider flex items-center gap-2"><i class="fas fa-ruler-combined"></i> اختر المقاس:</p>
                    <div id="sizes-container" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="mb-8">
                    <p class="text-xs text-gray-500 font-bold mb-3 uppercase tracking-wider flex items-center gap-2"><i class="fas fa-palette"></i> اختر اللون:</p>
                    <div id="colors-container" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="flex items-center justify-between bg-black/40 p-3 rounded-xl border border-white/5">
                        <span class="text-sm font-bold text-gray-400">الكمية المطلوبة:</span>
                        <div class="flex items-center gap-4">
                            <button onclick="updateQty(-1)" class="w-10 h-10 rounded-lg bg-white/5 hover:bg-white/10 text-white font-bold transition text-xl">-</button>
                            <span id="qty-display" class="font-black text-2xl w-8 text-center text-neonBlue">1</span>
                            <button onclick="updateQty(1)" class="w-10 h-10 rounded-lg bg-neonBlue/10 text-neonBlue hover:bg-neonBlue/20 font-bold transition text-xl">+</button>
                        </div>
                    </div>

                    <button id="add-btn" onclick="addToCartAndReturn()" disabled class="w-full bg-[#222] text-gray-500 font-bold py-5 rounded-2xl shadow-lg transition-all flex items-center justify-center gap-3 cursor-not-allowed group relative overflow-hidden">
                        <span class="relative z-10 group-hover:scale-105 transition">اختر المقاس واللون أولاً</span>
                        <i class="fas fa-hand-point-up animate-bounce relative z-10"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCUgMCQPD3LqQHhiJqGUykCvi4GkqIxBDg", authDomain: "akrabloko.firebaseapp.com", projectId: "akrabloko", storageBucket: "akrabloko.firebasestorage.app", messagingSenderId: "846428093028", appId: "1:846428093028:web:29f31599b90125c2673d71" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentProduct = null, selectedSize = null, selectedColor = null, qty = 1;
        let currentImgIndex = 0, allImages = [], touchStartX = 0, touchEndX = 0;

        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');
        
        if (!productId) {
            window.location.href = 'index.html';
        } else {
            loadProduct(productId);
        }

        async function loadProduct(id) {
            try {
                const docSnap = await getDoc(doc(db, "products", id));
                if (docSnap.exists()) {
                    const p = docSnap.data();
                    currentProduct = { id: docSnap.id, ...p };

                    // 1. عرض البيانات
                    document.getElementById('p-name').innerText = p.name;
                    document.getElementById('p-price').innerHTML = `${p.price} <span class="text-neonPink text-lg font-bold">ج.م</span>`;
                    document.getElementById('p-desc').innerText = p.desc;
                    document.getElementById('p-cat').innerText = p.category || 'عام';

                    // ==========================================
                    // بداية كود SEO (تم دمجه هنا بشكل صحيح ليعمل فوراً)
                    // ==========================================
                    
                    // أ. العنوان
                    document.title = `${p.name} | Akrabloko Store`;

                    // ب. الميتا تاج (الوصف)
                    let metaDesc = document.querySelector('meta[name="description"]');
                    if (!metaDesc) {
                        metaDesc = document.createElement('meta');
                        metaDesc.name = "description";
                        document.head.appendChild(metaDesc);
                    }
                    metaDesc.content = `اشتري ${p.name} بسعر ${p.price} جنيه. ${p.desc ? p.desc.substring(0, 100) : ''}...`;

                    // ج. السكيما (Schema)
                    const schemaData = {
                        "@context": "https://schema.org/",
                        "@type": "Product",
                        "name": p.name,
                        "image": [p.coverImage],
                        "description": p.desc,
                        "sku": p.id,
                        "offers": {
                            "@type": "Offer",
                            "url": window.location.href,
                            "priceCurrency": "EGP",
                            "price": p.price,
                            "availability": "https://schema.org/InStock"
                        }
                    };
                    const scriptSchema = document.createElement('script');
                    scriptSchema.type = "application/ld+json";
                    scriptSchema.textContent = JSON.stringify(schemaData);
                    document.head.appendChild(scriptSchema);
                    // ==========================================
                    // نهاية كود SEO
                    // ==========================================

                    // 2. الصور
                    allImages = [p.coverImage, ...(p.extraImages || [])];
                    updateGalleryUI();

                    // إعداد اللمس
                    const swipeArea = document.getElementById('swipe-area');
                    swipeArea.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
                    swipeArea.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, {passive: true});

                    // 3. الأزرار
                    const sizes = p.sizes || ['Free Size'];
                    document.getElementById('sizes-container').innerHTML = sizes.map(s => `
                        <label class="cursor-pointer group"><input type="radio" name="size" value="${s}" class="option-input sr-only" onchange="setSize('${s}')"><div class="bg-black border border-gray-700 px-5 py-3 rounded-xl text-sm font-bold text-gray-300 transition group-hover:border-white select-none">${s}</div></label>`).join('');

                    const colors = p.colors || ['Standard'];
                    document.getElementById('colors-container').innerHTML = colors.map(c => `
                        <label class="cursor-pointer group"><input type="radio" name="color" value="${c}" class="option-input sr-only" onchange="setColor('${c}')"><div class="bg-black border border-gray-700 px-5 py-3 rounded-xl text-sm font-bold text-gray-300 transition group-hover:border-white select-none">${c}</div></label>`).join('');

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('product-container').classList.remove('hidden');
                } else {
                    window.location.href = 'index.html';
                }
            } catch (e) {
                console.error(e);
                alert('حدث خطأ في تحميل المنتج');
            }
        }

        // باقي الدوال (الصور - السلة - الاختيار)
        function updateGalleryUI() {
            const mainImg = document.getElementById('main-img');
            const thumbsContainer = document.getElementById('thumbnails-container');
            const dotsContainer = document.getElementById('dots-container');
            
            mainImg.style.opacity = '0.5';
            setTimeout(() => { mainImg.src = allImages[currentImgIndex]; mainImg.style.opacity = '1'; }, 150);
            
            document.getElementById('img-counter').innerText = `${currentImgIndex + 1}/${allImages.length}`;

            if (allImages.length > 1) {
                dotsContainer.innerHTML = allImages.map((_, idx) => `<span class="dot ${idx === currentImgIndex ? 'active' : ''}"></span>`).join('');
                thumbsContainer.innerHTML = allImages.map((imgUrl, idx) => `
                    <img src="${imgUrl}" onclick="goToImage(${idx})" class="w-16 h-20 object-cover rounded-xl border-2 border-transparent cursor-pointer transition ${idx === currentImgIndex ? 'thumb-active' : 'opacity-60 hover:opacity-100'}">`).join('');
                thumbsContainer.style.display = 'flex'; dotsContainer.style.display = 'flex';
            } else {
                thumbsContainer.style.display = 'none'; dotsContainer.style.display = 'none';
