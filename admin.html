<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© V2 - Ø£Ù‚Ø±Ø¨Ù„ÙˆÙƒÙˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neonBlue: '#00f3ff',
                        neonPink: '#bc13fe',
                        darkBg: '#050505',
                        cardBg: '#111111'
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: white; font-family: 'Cairo', sans-serif; }
        .tab-btn { transition: all 0.3s; border-bottom: 2px solid transparent; opacity: 0.6; }
        .tab-btn.active { opacity: 1; border-color: #00f3ff; color: #00f3ff; text-shadow: 0 0 10px rgba(0, 243, 255, 0.4); }
        .order-card { transition: all 0.3s ease; }
        .order-card:hover { transform: translateY(-2px); }
        .badge-new { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="pb-20 min-h-screen flex flex-col">

    <nav class="sticky top-0 z-50 bg-black/90 backdrop-blur-xl border-b border-gray-800 p-4 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black text-white flex items-center gap-2">
                <i class="fas fa-user-astronaut text-neonPink"></i>
                <span class="hidden sm:inline">Ø£Ø¯Ù…Ù†</span> <span class="text-neonBlue">Ø£Ù‚Ø±Ø¨Ù„ÙˆÙƒÙˆ</span>
            </h1>
            <div class="flex items-center gap-3">
                <span id="order-count" class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full hidden animate-bounce">0</span>
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 mt-6 mb-4">
        <div class="flex justify-center bg-gray-900/50 p-1 rounded-xl border border-gray-800 max-w-md mx-auto">
            <button onclick="setFilter('new')" id="tab-new" class="tab-btn active flex-1 py-2 font-bold text-sm rounded-lg hover:bg-white/5">
                ğŸ”¥ Ø¬Ø¯ÙŠØ¯Ø©
            </button>
            <button onclick="setFilter('done')" id="tab-done" class="tab-btn flex-1 py-2 font-bold text-sm rounded-lg hover:bg-white/5">
                âœ… Ù…ÙƒØªÙ…Ù„Ø©
            </button>
            <button onclick="setFilter('all')" id="tab-all" class="tab-btn flex-1 py-2 font-bold text-sm rounded-lg hover:bg-white/5">
                ğŸ“‚ Ø§Ù„ÙƒÙ„
            </button>
        </div>
    </div>

    <div id="delete-section" class="container mx-auto px-4 mb-4 text-center hidden">
        <button onclick="deleteCompletedOrders()" class="text-red-500 hover:text-red-400 text-xs font-bold border border-red-900/50 bg-red-900/10 px-4 py-2 rounded-full transition flex items-center gap-2 mx-auto">
            <i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
        </button>
    </div>

    <div class="container mx-auto px-4 max-w-3xl flex-1">
        <div id="orders-list" class="space-y-4">
            <div class="text-center py-20 text-gray-600">
                <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-neonPink"></i>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø®Ø§ØµØ© (ÙƒÙ…Ø§ Ù‡ÙŠ)
        const firebaseConfig = {
            apiKey: "AIzaSyCUgMCQPD3LqQHhiJqGUykCvi4GkqIxBDg",
            authDomain: "akrabloko.firebaseapp.com",
            projectId: "akrabloko",
            storageBucket: "akrabloko.firebasestorage.app",
            messagingSenderId: "846428093028",
            appId: "1:846428093028:web:29f31599b90125c2673d71",
            measurementId: "G-31SP9TP2N1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allOrders = []; // Ù„ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        let currentFilter = 'new'; // Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹
        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            allOrders = [];
            let newCount = 0;

            snapshot.forEach((doc) => {
                const data = doc.data();
                data.id = doc.id; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ ID Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                allOrders.push(data);
                if(data.status === 'new') newCount++;
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø±
            const badge = document.getElementById('order-count');
            if(newCount > 0) {
                badge.innerText = newCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            renderOrders(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ØµÙØ­Ø©
        });

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
        window.renderOrders = () => {
            const list = document.getElementById('orders-list');
            const deleteSection = document.getElementById('delete-section');
            
            // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            let filteredOrders = allOrders;
            if (currentFilter === 'new') filteredOrders = allOrders.filter(o => o.status === 'new');
            if (currentFilter === 'done') filteredOrders = allOrders.filter(o => o.status === 'done');

            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· ÙÙŠ ØªØ§Ø¨ "Ù…ÙƒØªÙ…Ù„" Ø£Ùˆ "Ø§Ù„ÙƒÙ„"
            if (currentFilter === 'done' && filteredOrders.length > 0) {
                deleteSection.classList.remove('hidden');
            } else {
                deleteSection.classList.add('hidden');
            }

            if (filteredOrders.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 opacity-50">
                        <i class="fas fa-box-open text-4xl mb-3 text-gray-700"></i>
                        <p class="text-gray-500 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
                    </div>`;
                return;
            }

            // Ø±Ø³Ù… Ø§Ù„ÙƒØ±ÙˆØª
            list.innerHTML = filteredOrders.map(order => {
                const isNew = order.status === 'new';
                const statusClass = isNew 
                    ? 'border-neonPink shadow-[0_0_15px_rgba(188,19,254,0.15)] bg-[#111]' 
                    : 'border-gray-800 opacity-70 bg-black grayscale-[0.5]';
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
                let timeString = 'Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„';
                if(order.timestamp) {
                    timeString = order.timestamp.toDate().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
                }

                return `
                <div class="rounded-2xl p-5 border ${statusClass} order-card relative overflow-hidden mb-4">
                    <div class="flex justify-between items-start mb-3 pb-3 border-b border-gray-800">
                        <div>
                            <h3 class="font-bold text-white text-lg">${order.customer.name}</h3>
                            <a href="tel:${order.customer.phone}" class="text-neonBlue text-sm font-bold hover:underline">
                                ğŸ“ ${order.customer.phone}
                            </a>
                        </div>
                        <div class="text-left">
                            ${isNew 
                                ? '<span class="bg-neonPink text-white text-[10px] font-black px-2 py-1 rounded badge-new">Ø¬Ø¯ÙŠØ¯</span>' 
                                : '<span class="bg-gray-800 text-gray-400 text-[10px] font-bold px-2 py-1 rounded">Ù…ÙƒØªÙ…Ù„</span>'}
                            <div class="text-[10px] text-gray-500 mt-1 font-mono">${timeString}</div>
                        </div>
                    </div>

                    <div class="bg-gray-900/30 p-2 rounded mb-3 text-sm text-gray-300">
                        <i class="fas fa-map-marker-alt text-red-500 ml-1"></i> ${order.customer.address}
                    </div>

                    <div class="space-y-1 mb-4 text-sm text-gray-400">
                        ${order.items.map(i => `
                            <div class="flex justify-between border-b border-gray-800/50 pb-1 last:border-0">
                                <span>${i.name} <span class="text-white font-bold">x${i.qty}</span></span>
                                <span>${i.price * i.qty}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="flex justify-between items-center pt-2">
                        <span class="text-lg font-black text-white">${order.total} <span class="text-xs text-neonPink">Ø¬.Ù…</span></span>
                        
                        ${isNew ? `
                        <button onclick="updateStatus('${order.id}', 'done')" class="bg-green-600 hover:bg-green-500 text-white px-5 py-2 rounded-xl font-bold text-sm shadow-lg transition">
                            ØªØ³Ù„ÙŠÙ… âœ…
                        </button>
                        ` : `
                        <button onclick="updateStatus('${order.id}', 'new')" class="text-gray-500 hover:text-white text-xs font-bold underline">
                            Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ø¬Ø¯ÙŠØ¯ â†º
                        </button>
                        `}
                    </div>
                </div>
                `;
            }).join('');
        };

        // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ± (Tabs)
        window.setFilter = (filterType) => {
            currentFilter = filterType;
            // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${filterType}`).classList.add('active');
            renderOrders();
        };

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
        window.updateStatus = async (id, status) => {
            if(status === 'done' && !confirm('Ù‡Ù„ ØªÙ… ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙÙ„ÙˆØ³ØŸ ğŸ’°')) return;
            try {
                const orderRef = doc(db, "orders", id);
                await updateDoc(orderRef, { status: status });
            } catch (error) {
                console.error("Error updating: ", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
            }
        };

        // ğŸ”´ Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© ğŸ”´
        window.deleteCompletedOrders = async () => {
            if (!confirm("âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø§Ù„Ø£Ø±Ø´ÙŠÙ)ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©.")) return;
            
            const btn = document.querySelector('#delete-section button');
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...';
            btn.disabled = true;

            try {
                // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
                const q = query(collection(db, "orders"), where("status", "==", "done"));
                const querySnapshot = await getDocs(q);

                // 2. ØªØ¬Ù‡ÙŠØ² Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                // 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø³Ø­
                await batch.commit();
                alert("ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­! ğŸ§¹âœ¨");
                
            } catch (error) {
                console.error("Error deleting: ", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­");
            } finally {
                btn.innerHTML = '<i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©';
                btn.disabled = false;
            }
        };

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        setFilter('new');
    </script>
</body>
</html>
